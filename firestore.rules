rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // 'users' 컬렉션에 대해서는 모든 사람이 읽을 수 있고, 자신의 정보만 생성/수정 가능
    match /users/{userId} {
      allow read: if true; // 모든 사람이 프로필을 읽을 수 있음 (로그아웃 상태에서도 게시물 작성자 정보 표시용)
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;

      match /history/{historyId} {
        // [수정됨] 읽기 권한: 주인(B)이거나, 또는 행동한 사람(A)인 경우 허용
        allow read: if request.auth != null && (
          request.auth.uid == userId || 
          resource.data.actorId == request.auth.uid
        );

        allow create: if request.auth != null; 
        
        // 업데이트는 주인만 가능 (읽음 처리 등)
        allow update: if request.auth != null && request.auth.uid == userId && (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']) 
        );
        
        // [수정됨] 삭제 권한: 주인(B)이거나, 행동한 사람(A)인 경우 허용
        // 복잡한 조건 필요 없이 actorId만 확인하면 됩니다. (어차피 본인이 만든 것만 지우면 되니까요)
        allow delete: if request.auth != null && (
          request.auth.uid == userId || 
          resource.data.actorId == request.auth.uid
        );
      }

      // abandonment 서브컬렉션: 로그인한 유저가 자신의 abandonment만 관리 가능
      match /abandonment/{abandonmentId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create: if request.auth != null && request.auth.uid == userId;
        allow update: if request.auth != null && request.auth.uid == userId;
        allow delete: if request.auth != null && request.auth.uid == userId;
      }

      // cardnews 서브컬렉션: 스크랩한 카드뉴스 id 저장. 본인만 읽기/쓰기
      match /cardnews/{cardNewsId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // 'boards' 컬렉션에 대해서는 로그인된 사용자만 생성 가능
    match /boards/{boardId} {
      allow create: if request.auth != null;
      allow read: if true; // 모든 사람이 읽을 수 있게 (필요시)
      allow update: if request.auth != null && (
        request.auth.uid == resource.data.authorId || // 작성자가 모든 필드 수정 가능
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes'])) // 로그인한 사용자는 likes 필드만 업데이트 가능 (increment 포함)
      );
      allow delete: if request.auth != null && request.auth.uid == resource.data.authorId; // 작성자만 삭제

      // 좋아요 서브컬렉션 규칙 추가
      match /likeList/{userId} {
        allow read: if true; // 모든 사람이 좋아요 목록을 읽을 수 있음
        allow create: if request.auth != null && request.auth.uid == userId; // 자신의 ID로만 좋아요 생성 가능
        allow delete: if request.auth != null && request.auth.uid == userId; // 자신의 좋아요만 삭제 가능
      }

      // 댓글 서브컬렉션 규칙 추가
      match /comments/{commentId} {
        allow read: if true; // 모든 사람이 댓글을 읽을 수 있음
        allow create: if request.auth != null; // 로그인된 사용자만 댓글 작성 가능
        allow update: if request.auth != null && (
          request.auth.uid == resource.data.authorId || // 작성자가 수정하는 경우
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes'])) || // likes 필드만 업데이트하는 경우
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['repliesCount'])) || // repliesCount 필드만 업데이트하는 경우
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'repliesCount'])) // likes와 repliesCount 필드만 업데이트하는 경우
        );
        allow delete: if request.auth != null && request.auth.uid == resource.data.authorId; // 작성자만 삭제

        // 댓글 좋아요 서브컬렉션 규칙 추가
        match /likeList/{userId} {
          allow read: if true; // 모든 사람이 좋아요 목록을 읽을 수 있음
          allow create: if request.auth != null && request.auth.uid == userId; // 자신의 ID로만 좋아요 생성 가능
          allow delete: if request.auth != null && request.auth.uid == userId; // 자신의 좋아요만 삭제 가능
        }

        // 대댓글 서브컬렉션 규칙 추가
        match /replies/{replyId} {
          allow read: if true; // 모든 사람이 대댓글을 읽을 수 있음
          allow create: if request.auth != null; // 로그인된 사용자만 대댓글 작성 가능
          allow update: if request.auth != null && (
            request.auth.uid == resource.data.authorId || // 작성자가 수정하는 경우
            (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes'])) // likes 필드만 업데이트하는 경우
          );
          allow delete: if request.auth != null && request.auth.uid == resource.data.authorId; // 작성자만 삭제
        }
      }
    }

    // 'shelter' 컬렉션: 보호소 소개 정보
    match /shelter/{shelterId} {
      allow read: if true; // 모든 사람이 보호소 소개 정보를 읽을 수 있음
      allow create: if request.auth != null; // 로그인한 사용자만 생성 가능
      // 작성자, 해당 보호소 관리자(shelterInfo.careRegNo == shelterId), 전체 관리자(fulladmin)만 수정 가능
      // users 문서의 shelterInfo.careRegNo는 문자열이어야 함 (숫자면 규칙 비교 실패)
      allow update: if request.auth != null && resource.exists && (
        request.auth.uid == resource.data.get('authorId', '')
        || (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('shelterInfo', null) != null
            && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('shelterInfo', {}).get('careRegNo', '') == shelterId)
        || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('fulladmin', false) == true
      );
      allow delete: if false; // 삭제 불가
    }

    // 'notice' 컬렉션: 공지사항 (읽기는 모두, 작성/수정/삭제는 fulladmin만. 조회수는 view 서브컬렉션 개수로 판단)
    match /notice/{noticeId} {
      allow read: if true; // 모든 사람이 공지사항을 읽을 수 있음
      allow create, update, delete: if request.auth != null
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.fulladmin == true;

      // view 서브컬렉션: IP별 조회 기록 (중복 조회 방지). 누구나 읽기/생성만 가능
      match /view/{viewId} {
        allow read, create: if true;
        allow update, delete: if false;
      }

      // 공지 댓글 서브컬렉션 (boards와 동일한 규칙)
      match /comments/{commentId} {
        allow read: if true;
        allow create: if request.auth != null;
        allow update: if request.auth != null && (
          request.auth.uid == resource.data.authorId ||
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes'])) ||
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['repliesCount'])) ||
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'repliesCount']))
        );
        allow delete: if request.auth != null && request.auth.uid == resource.data.authorId;

        match /likeList/{userId} {
          allow read: if true;
          allow create: if request.auth != null && request.auth.uid == userId;
          allow delete: if request.auth != null && request.auth.uid == userId;
        }

        match /replies/{replyId} {
          allow read: if true;
          allow create: if request.auth != null;
          allow update: if request.auth != null && (
            request.auth.uid == resource.data.authorId ||
            (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']))
          );
          allow delete: if request.auth != null && request.auth.uid == resource.data.authorId;
        }
      }
    }

    // 'cardNews' 컬렉션: 카드뉴스 (작성자/좋아요/댓글)
    match /cardNews/{cardNewsId} {
      allow read: if true; // 모든 사람이 읽기 가능
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        request.auth.uid == resource.data.authorId || // 작성자 수정
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likeIds', 'likeCount'])) // 좋아요만 변경
      );
      allow delete: if request.auth != null && request.auth.uid == resource.data.authorId;

      match /comments/{commentId} {
        allow read: if true;
        allow create: if request.auth != null;
        allow update: if request.auth != null && (
          request.auth.uid == resource.data.authorId ||
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']))
        );
        allow delete: if request.auth != null && request.auth.uid == resource.data.authorId;
      }

      // liked 서브컬렉션: 좋아요 누른 사용자 id (문서 id = userId)
      match /liked/{userId} {
        allow read: if true;
        allow create, delete: if request.auth != null && request.auth.uid == userId;
      }

      // view 서브컬렉션: IP별 조회 기록 (중복 조회 방지). 누구나 읽기/생성만 가능
      match /view/{viewId} {
        allow read, create: if true;
        allow update, delete: if false;
      }
    }

    // 모든 문서에 대한 기본 접근은 여전히 막고
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

